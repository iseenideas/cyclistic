---
title: "Case Study: How Does a Bike-Share Navigate Speedy Success?"
author: "Nelson Isea, He/Him"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: true
    toc_depth: 2
    number_sections: false
editor_options: 
  chunk_output_type: console
---

```{r, setup-options, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r, libraries, message = FALSE, warning = FALSE, echo=FALSE}
library(rmarkdown)
library(knitr)
library(tidyverse)
library(mice)
library(naniar)
library(janitor)
library(skimr)
library(stringdist)
library(lubridate)
library(geosphere)
library(fedmatch)
library(leaflet)
library(s2)
library(scales)
```

# About {.tabset}

```{r, out.width = "33%"}
include_graphics('~/Documents/Case_Study_2022_001/images/Cyclistic_logo.png', dpi = NA)
```

**Cyclistic** is a fictional bike-share program featuring 5800+ geotracked bicycles and 600+ docking stations around Chicago. Bikes may be unlocked from one station and returned to any other station in the system at anytime. Although Cyclistic is fictional, the data stems from real program operated by [Divvy](https://ride.divvybikes.com/), a business partner in the City of Chicago's bike sharing system.

While most riders opt for classic bikes and ride for leisure, approximately 30% ride for daily commute to schools, universities, or work. Casual riders typically buy either single-ride or full-day passes while annual members enjoy unlimited rides throughout the year. Cyclistic sets itself apart by offering assistive options to about 8% of its riders.

The purpose of this report is to provide insights extracted from the publicly available data on how riders use the service. The report presents recommendations for a new marketing program seeking to drive conversion of casual riders into annual members.

*This report is the author's capstone project to attain the Google Data Analytics Professional Certificate.*

# Our Team {.tabset}

The Cyclistic team includes: **Executives,** a notoriously detail-oriented group who decides whether to approve the new marketing program; Lily Moreno, the **Marketing Director,** responsible for the development of campaigns and initiatives to promote the service over email, social media, and other channels; and the **Marketing Team**, a group of data analysts, including the author, who are responsible for collecting, analyzing, and reporting on business data. 

# Business Task {.tabset}

Understanding how riders benefit from the program is key to designing new marketing initiatives. Until now, Cyclisticâ€™s marketing solely relied on building general awareness to broad consumer segments through the flexibility of its pricing plans. The Marketing Director firmly believes that maximizing the number of annual members is crucial to the company's future. Therefore, the new strategy will prioritize casual riders' conversion to members.  

Insights from this report clear the way for Lily Moreno and the Marketing Team to answer these questions:

1. How do annual members and casual riders use Cyclistic bikes differently?
2. Why would casual riders buy annual memberships?
3. How can Cyclistic use digital media to influence casual riders to become members?

The business task at hand is to answer the first question.

# Analysis Summary {.tabset}

Our last 12 month's data presents user's behavior as season-dependent with Summer and Fall being peak seasons. Members rode for half the average time of casual riders. Members rode more during the week while casuals rode more during weekends. This implies that members commute more than casuals. My recommendations are: (1) to communicate the benefit at all stations with posters and prompt casuals to sign up (2) to conduct a 7-day trial campaign during the peak months, and (3) to partner with indoor event organizers during colder months and offer casual riders discounted tickets upon signing up for an annual membership.   

# Data Sources {.tabset}

## Stations

**Source:** [Stations](https://data.cityofchicago.org/Transportation/Divvy-Bicycle-Stations-All-Map/bk89-9dk7)  
**Description:** A list of stations where riders collect and return bikes  
**Owned by:** The City of Chicago  
**Provided by:** Divvy, powered by Lyft  
**Last updated:** August 29th, 2022  
**Instructions:** Click export, download as CSV to ~/project folder  

```{r, import-v00, echo=FALSE}
stations_v00 <- as_tibble(read_csv("~/Documents/Case_Study_2022_001/csv_files/Divvy_Bicycle_Stations_All.csv", show_col_types = FALSE))
```

**Data Structure**

```{r, db-structure-v00, echo=FALSE}
str(stations_v00)
```

**Sample data**

```{r, table-v01, echo=FALSE, results='asis'}
table_v01 <- stations_v00 %>% select(ID, `Station Name`, Latitude, Longitude) %>% arrange(`Station Name`) %>% head()
knitr::kable(table_v01, caption = "Table 1. Stations - sample of raw data") 
```

## Trips 

**Source:** [Trips](https://divvy-tripdata.s3.amazonaws.com/index.html)   
**Description:** Time stamped trip data with start and end location  
**Owned by:** The City of Chicago  
**Provided by:** Divvy, powered by Lyft  
**Last updated:** August 6th, 2022  
**Instructions:** Download to ~/project_folder, extract with decompression software  

```{r, import-v01, echo=FALSE}
aug_22 <- read_csv("~/Documents/Case_Study_2022_001/csv_files/202208-divvy-tripdata.csv", show_col_types = FALSE)  
jul_22 <- read_csv("~/Documents/Case_Study_2022_001/csv_files/202207-divvy-tripdata.csv", show_col_types = FALSE)  
jun_22 <- read_csv("~/Documents/Case_Study_2022_001/csv_files/202206-divvy-tripdata.csv", show_col_types = FALSE)  
may_22 <- read_csv("~/Documents/Case_Study_2022_001/csv_files/202205-divvy-tripdata.csv", show_col_types = FALSE)  
apr_22 <- read_csv("~/Documents/Case_Study_2022_001/csv_files/202204-divvy-tripdata.csv", show_col_types = FALSE)  
mar_22 <- read_csv("~/Documents/Case_Study_2022_001/csv_files/202203-divvy-tripdata.csv", show_col_types = FALSE)  
feb_22 <- read_csv("~/Documents/Case_Study_2022_001/csv_files/202202-divvy-tripdata.csv", show_col_types = FALSE)  
jan_22 <- read_csv("~/Documents/Case_Study_2022_001/csv_files/202201-divvy-tripdata.csv", show_col_types = FALSE)  
dec_21 <- read_csv("~/Documents/Case_Study_2022_001/csv_files/202112-divvy-tripdata.csv", show_col_types = FALSE)  
nov_21 <- read_csv("~/Documents/Case_Study_2022_001/csv_files/202111-divvy-tripdata.csv", show_col_types = FALSE)  
oct_21 <- read_csv("~/Documents/Case_Study_2022_001/csv_files/202110-divvy-tripdata.csv", show_col_types = FALSE)  
sep_21 <- read_csv("~/Documents/Case_Study_2022_001/csv_files/202109-divvy-tripdata.csv", show_col_types = FALSE)  
```

**Data Structure**

1. Compare structure among csv files

```{r, compare-v00, echo=FALSE}
compare_df_cols(aug_22, jul_22, jun_22)
```

*only last 3 months shown though the source code checked structure for the rest*

Data types are compatible 

2. Combine last 12 months

```{r, combine-v00, echo=FALSE}
last_12m_v00 <- bind_rows(aug_22, jul_22, jun_22, may_22, apr_22, mar_22, feb_22, jan_22, dec_21, nov_21, oct_21, sep_21)
```

3. Sample data

```{r, table-v02, echo=FALSE, results='asis'}
table_v02 <- head(last_12m_v00)
knitr::kable(table_v02, caption = "Table 2. Trips - sample of raw data") 
```

4. Clear environment and free unused memory

```{r, echo=FALSE}
rm(aug_22, jul_22, jun_22, may_22, apr_22, mar_22, feb_22, jan_22, dec_21, nov_21, oct_21, sep_21)
gc()
```

# Data Manipulation {.tabset}

## Stations

**Clean station names**

1. Select variables relevant to the business task
2. Clean variable names
3. Convert id to character
4. Snake_case observations
5. Rearrange columns
6. Round up location data to 5th decimal
7. Sort alphabetically by station name

```{r, cleaning-steps-v00, echo=FALSE}
stations_v01 <- stations_v00 %>% 
  select(ID:`Station Name`,
         Latitude:Longitude) %>% 
  clean_names() %>% 
  mutate(valid_id = as.character(id),
         station = clean_strings(string = stations_v00$`Station Name`)) %>% 
  select(valid_id:station,
         latitude:longitude) %>% 
  mutate(station = str_replace_all(station, coll(" "), "_"),
         .keep = "unused") %>% 
  rename(valid_longitude = longitude,
         valid_latitude = latitude) %>% 
  relocate(valid_id, .before = valid_latitude) %>% 
  mutate(valid_longitude = round(valid_longitude, 5),
         valid_latitude = round(valid_latitude, 5)) %>% 
  arrange(station)
```

8. Inspect result

```{r, table-v03, echo=FALSE, results='asis'}
table_v03 <- head(stations_v01)
knitr::kable(table_v03, caption = "Table 3. Dirty valid stations") 
```

9. Check for duplicates per variable and list findings

    + station

```{r, duplicates-v00, echo=FALSE}
stations_v01 %>% get_dupes(station)
```

      wilton_ave_and_diversey_pkwy 
      Remove valid_id 13 

    + valid_id

```{r, duplicates-v01, echo=FALSE}
stations_v01 %>% get_dupes(valid_id)
```
      
      1038 unique ids out of 1417 stations, ids not to be used as secondary keys
      618 instances where same id is used for stations with different names
      Many start with "public_rack_"
      Suspect members locked bikes to a permitted public location 
      Coordinates for duplicates are close to one another
      Check number of characters (nchar)
      
```{r, nchar-v00, echo=FALSE}
table(nchar(stations_v01$valid_id))
```
    
      Suspect the sum of 1,2,3 chars = 679 might be the cyclistic operated stations whereas
      ids with 18, 19 chars = 738 might be public locations 
  
    + location data

```{r, duplicates-v02, echo=FALSE}
stations_v01 %>% get_dupes(valid_latitude, valid_longitude)
```

      Error (typo) in public_rack_laflin_st_and51st_st (and51)
      Because there is a correct public_rack_laflin_st_and_51st_st, remove record with typo

10. Remove duplicates and typos

```{r, view-v01, echo=FALSE}
stations_v02 <- stations_v01 %>% filter(valid_id != "13") %>% 
  filter(station != "public_rack_laflin_st_and51st_st")
```

11. Check for missing values

```{r, NAs, echo=FALSE}
any_na(stations_v02) 
```

12. Inspect result

```{r, table-v04, echo=FALSE, results = 'asis'}
table_v04 <- head(stations_v01)
knitr::kable(table_v04, caption = "Table 4. Clean valid stations") 
```

## Trips

**Clean station names**

1. Snake_case observations
2. Rearrange columns
3. Round up location data to 5th decimal
4. Sort alphabetically by station name

```{r, cleaning-steps-v01, echo=FALSE}
last_12m_v01 <- last_12m_v00 %>% 
  mutate(rideable_type = clean_strings(rideable_type),
         start_station_name = clean_strings(start_station_name),
         start_station_id = clean_strings(start_station_id),
         end_station_name = clean_strings(end_station_name),
         end_station_id = clean_strings(end_station_id),
         member_casual = clean_strings(member_casual),
         .keep = "unused") %>% 
  mutate(rideable_type = str_replace_all(rideable_type, coll(" "), "_"),
         start_station_name = str_replace_all(start_station_name, coll(" "), "_"),
         start_station_id = str_replace_all(start_station_id, coll(" "), "_"),
         end_station_name = str_replace_all(end_station_name, coll(" "), "_"),
         end_station_id = str_replace_all(end_station_id, coll(" "), "_")) %>% 
  select(everything()) %>%   
  rename(user_type = member_casual,
         bike_type = rideable_type,
         start_station = start_station_name,
         start_id = start_station_id,
         end_station = end_station_name,
         end_id = end_station_id,
         started = started_at,
         ended = ended_at) %>% 
  relocate(user_type, .before = bike_type) %>% 
  relocate(started:ended, .after = end_lng) %>% 
  relocate(end_id, .after = end_station) %>% 
  mutate(start_lat = round(start_lat, 5),
         start_lng = round(start_lng, 5),
         end_lat = round(end_lat, 5),
         end_lng = round(end_lng, 5),
         .keep = "unused") %>% 
  arrange(start_station)
```

5. Inspect distinct values per variable and list findings

    + ride_id

```{r, dinstinc-v00, echo=FALSE}
last_12m_v01 %>% distinct(ride_id)
```

      Unique identifier (primary key)

    + user_type

```{r, distinct-v01, echo=FALSE}
last_12m_v01 %>% distinct(user_type)
```

      casual, member

    + bike_type

```{r, distinct-v02, echo=FALSE}
last_12m_v01 %>% distinct(bike_type)
```

      3 options: classic, electric, docked
      docked_bike seems to be an ambiguous term
      Ask stakeholders: 
        *Do these units refer to bikes for people with disabilities?
        *Should docked_bikes be aggregated to the classic_bikes count?  

    + start_station
    
```{r, distinct-v03, echo=FALSE}
last_12m_v01 %>% distinct(start_station)
```

      1,432 unique start station names + NA 

    + start_id
    
```{r, distinct-v04, echo=FALSE}
last_12m_v01 %>% distinct(start_id)
```

      1,272 unique start station names + NA 
      Ids are complex and unstructured  
      Logically a 3-dig numbers appear correct (0 - 999 stations)  
      Some Ids are a mix of letters and digits  
      Ask stakeholders: 
        *How were ids determined/assigned?
      
    + end_station
    
```{r, distinct-v05, echo=FALSE}
last_12m_v01 %>% distinct(end_station)
```

      1,446 unique start station names + NA 

6. Create separate tibbles from start and end stations, exclude missing values

```{r, distinct-v06, echo=FALSE}
start_st_v00 <- last_12m_v01 %>% select (start_station:start_id, start_lat:start_lng) %>% 
  distinct(start_station, .keep_all = TRUE) %>% na.omit() %>% 
  arrange(start_station)

end___st_v00 <- last_12m_v01 %>% select (end_station:end_id, end_lat:end_lng) %>% 
  distinct(end_station, .keep_all = TRUE) %>% na.omit() %>% 
  arrange(end_station)
```

7. Combine both into a table of all station names 

      Select combined columns only  
      Rename variables
      Filter by distinct station

```{r, combine-v01, echo=FALSE}
all_stat_v00 <- bind_rows(start_st_v00, end___st_v00, .id = NULL) %>% 
  select(start_station:start_lng) %>% 
  rename(station = start_station,
         latitude = start_lat,
         longitude = start_lng, 
         id = start_id) %>% na.omit() %>% 
  distinct(station, .keep_all = TRUE)
```

8. Check for duplicates

```{r, duplicates-v03, echo=FALSE}
all_stat_v00 %>% get_dupes(station)
```

      No duplicates found

9. Check whether there are exact matches between dirty data and valid stations

      First iteration of left join between dirty stations and clean stations 

```{r, left-join-v00, echo=FALSE}
all_stat_v01 <- left_join(all_stat_v00, stations_v02, by = "station", keep = TRUE)
```

      Rearrange columns for comparison

```{r, arrange-v00, echo=FALSE}
all_stat_v02 <- all_stat_v01 %>% rename(station = station.x,
                                        valid_station = station.y) %>% 
  relocate(valid_station, .before = id) %>% 
  relocate(valid_id, .after = id) %>% 
  relocate(valid_latitude, .after = latitude) %>% 
  relocate(valid_longitude, .after = longitude) 
```

      Check exact matches

```{r, exact-matches-v00, echo=FALSE}
all_stat_v02$validated_station <- all_stat_v02$station %in% all_stat_v02$valid_station
all_stat_v03 <- all_stat_v02 %>% relocate(validated_station, .before = id) %>% arrange(validated_station) 
table(str_count(all_stat_v03$validated_station, "FALSE")) 
```

        TRUE (0) for exactly matched names
        FALSE (1) 399 names did not match

10. Investigate unmatched/invalid names

      Split in groups

      a. Validated station names

```{r, split-v00, echo=FALSE}
validsta_v00 <- all_stat_v03 %>% select(station,
                                        validated_station,
                                        id,
                                        latitude,
                                        longitude) %>% 
  filter(validated_station == "TRUE") 
```

      b. Not exact matches or invalid

```{r, split-v01, echo=FALSE}
invalsta_v00 <- all_stat_v03 %>% select(station,
                                        validated_station,
                                        id,
                                        latitude,
                                        longitude)  %>% 
  filter(validated_station == "FALSE") 
```

      Check for approximate matches with fuzzy string matching and the Levenshtein algorithm

```{r, fuzzy-matches-v00, echo=FALSE}
wrongsta_v00 <- as_vector(invalsta_v00$station)
validsta_v01 <- stations_v02$station
amatch(wrongsta_v00, validsta_v01, maxDist = 10)
closemtc_v00 <- stations_v02[amatch(wrongsta_v00, validsta_v01, maxDist = 10),]
closemtc_v00$wrong_name <- wrongsta_v00
closemtc_v00 <- closemtc_v00 %>% relocate(wrong_name)
```

      Conduct manual checks
    
        Manual checks led me to conclude that further cleaning of station names in both tables   
        may increase the number of exact matches. For example, some names where the id is a 18 
        or 19 digit char end with "public_rack_" or "pubic_rack". if these suffixes were removed,  
        more station names become exact matches. 

        Noticed the same applied to station names ending in _temp, _charging, _warehouse.

11. Remove prefixes/suffixes

```{r, cleaning-steps-v02, echo=FALSE}
stations_v03 <- stations_v02 %>% 
  mutate(station = str_remove_all(station, coll("public_rack_"))) %>% 
  mutate(station = str_remove_all(station, coll("pubic_rack_"))) %>% 
  mutate(station = str_remove_all(station, coll("_temp"))) %>% 
  mutate(station = str_remove_all(station, coll("_charging"))) %>% 
  mutate(station = str_remove_all(station, coll("_warehouse")))

all_stat_v04 <- all_stat_v03 %>% select(station,
                                        id,
                                        latitude,
                                        longitude) %>% 
  mutate(station = str_remove_all(station, coll("public_rack_"))) %>% 
  mutate(station = str_remove_all(station, coll("pubic_rack_"))) %>% 
  mutate(station = str_remove_all(station, coll("_temp"))) %>% 
  mutate(station = str_remove_all(station, coll("_charging"))) %>% 
  mutate(station = str_remove_all(station, coll("_warehouse")))
```

      Check for duplicates

```{r, duplicates-v04, echo=FALSE}
dupe_sta_v02 <- stations_v03 %>% get_dupes(station)
```

        52 entries, 26 stations with same name but different ids

      To avoid duplication issues, decided to filter and use distinct names

```{r, distinct-v07, echo=FALSE}
stations_v04 <- stations_v03 %>% distinct(station, .keep_all = TRUE)
```

12. Check whether removal of prefixes/suffixes improved the number of exact matches

      Second iteration of left join between dirty stations and valid stations 

```{r, left-join-v01, echo=FALSE}
all_stat_v05 <- left_join(all_stat_v04, stations_v04, 
                              by = "station", 
                              keep = TRUE)
```

        Only 34 names not found. Improved from 399 (Aha Moment!)

13. Repeat comparison steps

```{r, arrange-v01, echo=FALSE}
all_stat_v06 <- all_stat_v05 %>% rename(station = station.x, valid_station = station.y) %>% 
  relocate(valid_station, .after = station) %>% 
  relocate(valid_id, .after = id) %>% 
  relocate(valid_latitude, .after = latitude) 

all_stat_v06$validated_station <- all_stat_v06$station %in% all_stat_v06$valid_station
all_stat_v07 <- all_stat_v06 %>% relocate(validated_station, .before = id)
table(str_count(all_stat_v07$validated_station, "FALSE"))

invalsta_v01 <- all_stat_v07 %>% select(station, validated_station, id, latitude, longitude) %>% 
  filter(validated_station == "FALSE")
```

      Conduct manual checks

        Found stations with typos to be repaired
        Stations to be classified as "cyclistic_service" (charging, warehouse, mobile repair)
        Searched online for invalid names and found out that some were currently "out_of_service"

14. Apply manual corrections
    
```{r, cleaning-steps-v03, echo=FALSE}
all_stat_v08 <- all_stat_v07 %>%  
#   Stations with typos
  mutate(station = str_replace_all(station, coll("63rd_and_western_ave_north_corner"), "63rd_and_western_ave_n")) %>% 
  mutate(station = str_replace_all(station, coll("63rd_and_western_ave_south_corner"), "63rd_and_western_ave_s")) %>% 
  mutate(station = str_replace_all(station, coll("ashland_ave_and_45th_st_midblock_south"), "ashland_ave_and_45th_st_s")) %>% 
  mutate(station = str_replace_all(station, coll("austin_ave_and_wellington_ave_midblock"), "austin_ave_and_wellington_ave")) %>% 
  mutate(station = str_replace_all(station, coll("ewing_ave_and_96th_st"), "ewing_ave_and_96th_st_n")) %>% 
  mutate(station = str_replace_all(station, coll("kedvale_ave_and_63rd_st"), "kedvale_ave_and_63rd_st_e")) %>% 
  mutate(station = str_replace_all(station, coll("kedzie_and_103rd_st_west"), "kedzie_and_103rd_st_w")) %>% 
  mutate(station = str_replace_all(station, coll("kedzie_ave_and_61st_pl"), "kedzie_ave_and_61st_pl_e")) %>% 
  mutate(station = str_replace_all(station, coll("kedzie_ave_andamp_62nd_pl"), "kedzie_ave_and_62nd_pl")) %>% 
  mutate(station = str_replace_all(station, coll("keeler_ave_and_madison_st"), "keeler_ave_and_madison_st_s")) %>% 
  mutate(station = str_replace_all(station, coll("kenneth_ave_and_63rd_st"), "kenneth_ave_and_63rd_st_e")) %>% 
  mutate(station = str_replace_all(station, coll("mt_greenwood_library_north"), "mt_greenwood_library_n")) %>% 
  mutate(station = str_replace_all(station, coll("n_shore_channel_trail_and_argyle_ave"), "n_shore_channel_trail_and_argyle_st")) %>% 
  mutate(station = str_replace_all(station, coll("prairie_ave_and_47th_st_midblock"), "prairie_ave_and_47th_st")) %>% 
  mutate(station = str_replace_all(station, coll("talman_ave_and_51st_st_midblock"), "talman_ave_and_51st_st")) %>% 
  mutate(station = str_replace_all(station, coll("whippie_st_and_26th_st"), "whipple_st_and_26th_st")) %>% 
  mutate(station = str_replace_all(station, coll("woodlawn_ave_and_63rd_st_ne"), "woodlawn_ave_and_63rd_st_n")) %>% 
  mutate(station = str_replace_all(station, coll("woodlawn_ave_and_63rd_st_se"), "woodlawn_ave_and_63rd_st_s")) %>% 
  #   Stations that appear to be cyclistic service
  mutate(station = str_replace_all(station, coll("base_2132_w_hubbard"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("base_2132_w_hubbard_warehouse"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("divvy_cassette_repair_mobile_station"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("divvy_valet_oakwood_beach"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("hastings_wh_2"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("pawel_bialowas_test_pbsc_station"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("throop_hastings_mobile_station"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("west_chi_watson"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("westchi"), "cyclistic_service")) %>% 
  #   Stations that appear to be out of service
  mutate(station = str_replace_all(station, coll("dusable_lake_shore_dr_and_ohio_st"), "out_of_service")) %>% 
  mutate(station = str_replace_all(station, coll("lamon_ave_and_archer_ave"), "out_of_service")) %>% 
  mutate(station = str_replace_all(station, coll("morgan_st_and_lake_st"), "out_of_service")) %>% 
  mutate(station = str_replace_all(station, coll("newhastings"), "out_of_service")) %>% 
  mutate(station = str_replace_all(station, coll("whipple_st_and_irving_park_rd"), "out_of_service"))
```
    
        Trips from and to a cyclistic service station or an out-of-service station will be ignored on
        the assumption that these trips were completed by a cyclistic customer service representative 
        (Ask stakeholders)

        Stations identified as charging stations will be included though these could be ignored too:
        
        Charging stations

          *Bissell St & Armitage Ave
          *Green St & Randolph St
          *Lincoln Ave & Roscoe St
          *Morgan St & Lake St
          *Wilton Ave & Diversey Pkwy

15. Check name matching again

        Third iteration of left join between dirty stations and valid stations 

```{r, left-join-v02, echo=FALSE}
all_stat_v09 <- all_stat_v08 %>% select(station, latitude, longitude, id)
all_stat_v10 <- left_join(all_stat_v09, stations_v04, by = "station", keep = TRUE)
all_stat_v10$validated_name <- all_stat_v10$station.x %in% all_stat_v10$station.y
table(str_count(all_stat_v10$validated_name, "FALSE")) 
```

        Consider the 14 unmatched names as 'outliers'

```{r, outliers-v00, echo=FALSE}
outliers_v00 <- all_stat_v10 %>% filter(validated_name == FALSE) %>% select(station.x:id) %>% 
  rename(station = station.x,
         valid_latitude = latitude,
         valid_longitude = longitude,
         valid_id = id) %>% 
  mutate(valid_id = station) %>%  
  relocate(valid_id, .after = station)
```

16. Add outliers (unrecognized names) to valid stations

```{r, echo=FALSE}
stations_v05 <- rbind(stations_v04, outliers_v00)
```

17. Clean start station names with valid station names obtained from the city of Chicago (stations_v05)

```{r, echo=FALSE}
last_12m_v02 <- last_12m_v01 %>% rename(
  station = start_station) %>%  
  mutate(station = str_remove_all(station, coll("public_rack_"))) %>% 
  mutate(station = str_remove_all(station, coll("pubic_rack_"))) %>% 
  mutate(station = str_remove_all(station, coll("_temp"))) %>% 
  mutate(station = str_remove_all(station, coll("_charging"))) %>% 
  mutate(station = str_remove_all(station, coll("_warehouse"))) %>% 
#   Stations with typos
  mutate(station = str_replace_all(station, coll("63rd_and_western_ave_north_corner"), "63rd_and_western_ave_n")) %>% 
  mutate(station = str_replace_all(station, coll("63rd_and_western_ave_south_corner"), "63rd_and_western_ave_s")) %>% 
  mutate(station = str_replace_all(station, coll("ashland_ave_and_45th_st_midblock_south"), "ashland_ave_and_45th_st_s")) %>% 
  mutate(station = str_replace_all(station, coll("austin_ave_and_wellington_ave_midblock"), "austin_ave_and_wellington_ave")) %>% 
  mutate(station = str_replace_all(station, coll("ewing_ave_and_96th_st"), "ewing_ave_and_96th_st_n")) %>% 
  mutate(station = str_replace_all(station, coll("kedvale_ave_and_63rd_st"), "kedvale_ave_and_63rd_st_e")) %>% 
  mutate(station = str_replace_all(station, coll("kedzie_and_103rd_st_west"), "kedzie_and_103rd_st_w")) %>% 
  mutate(station = str_replace_all(station, coll("kedzie_ave_and_61st_pl"), "kedzie_ave_and_61st_pl_e")) %>% 
  mutate(station = str_replace_all(station, coll("kedzie_ave_andamp_62nd_pl"), "kedzie_ave_and_62nd_pl")) %>% 
  mutate(station = str_replace_all(station, coll("keeler_ave_and_madison_st"), "keeler_ave_and_madison_st_s")) %>% 
  mutate(station = str_replace_all(station, coll("kenneth_ave_and_63rd_st"), "kenneth_ave_and_63rd_st_e")) %>% 
  mutate(station = str_replace_all(station, coll("mt_greenwood_library_north"), "mt_greenwood_library_n")) %>% 
  mutate(station = str_replace_all(station, coll("n_shore_channel_trail_and_argyle_ave"), "n_shore_channel_trail_and_argyle_st")) %>% 
  mutate(station = str_replace_all(station, coll("prairie_ave_and_47th_st_midblock"), "prairie_ave_and_47th_st")) %>% 
  mutate(station = str_replace_all(station, coll("talman_ave_and_51st_st_midblock"), "talman_ave_and_51st_st")) %>% 
  mutate(station = str_replace_all(station, coll("whippie_st_and_26th_st"), "whipple_st_and_26th_st")) %>% 
  mutate(station = str_replace_all(station, coll("woodlawn_ave_and_63rd_st_ne"), "woodlawn_ave_and_63rd_st_n")) %>% 
  mutate(station = str_replace_all(station, coll("woodlawn_ave_and_63rd_st_se"), "woodlawn_ave_and_63rd_st_s")) %>% 
#   Stations that appear to be Cyclistic service
  mutate(station = str_replace_all(station, coll("base_2132_w_hubbard"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("base_2132_w_hubbard_warehouse"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("divvy_cassette_repair_mobile_station"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("divvy_valet_oakwood_beach"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("hastings_wh_2"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("pawel_bialowas_test_pbsc_station"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("throop_hastings_mobile_station"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("west_chi_watson"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("westchi"), "cyclistic_service")) %>% 
#   Stations that appear to be out of service
  mutate(station = str_replace_all(station, coll("dusable_lake_shore_dr_and_ohio_st"), "out_of_service")) %>% 
  mutate(station = str_replace_all(station, coll("lamon_ave_and_archer_ave"), "out_of_service")) %>% 
  mutate(station = str_replace_all(station, coll("morgan_st_and_lake_st"), "out_of_service")) %>% 
  mutate(station = str_replace_all(station, coll("newhastings"), "out_of_service")) %>% 
  mutate(station = str_replace_all(station, coll("whipple_st_and_irving_park_rd"), "out_of_service"))
```

18. Clean end station names with valid station names obtained from the city of Chicago

```{r, echo=FALSE}
last_12m_v03 <- last_12m_v02 %>% rename(
  start_station = station) %>% rename(
    station = end_station) %>%  
  mutate(station = str_remove_all(station, coll("public_rack_"))) %>% 
  mutate(station = str_remove_all(station, coll("pubic_rack_"))) %>% 
  mutate(station = str_remove_all(station, coll("_temp"))) %>% 
  mutate(station = str_remove_all(station, coll("_charging"))) %>% 
  mutate(station = str_remove_all(station, coll("_warehouse"))) %>% 
#   Station with typo
  mutate(station = str_replace_all(station, coll("63rd_and_western_ave_north_corner"), "63rd_and_western_ave_n")) %>% 
  mutate(station = str_replace_all(station, coll("63rd_and_western_ave_south_corner"), "63rd_and_western_ave_s")) %>% 
  mutate(station = str_replace_all(station, coll("ashland_ave_and_45th_st_midblock_south"), "ashland_ave_and_45th_st_s")) %>% 
  mutate(station = str_replace_all(station, coll("austin_ave_and_wellington_ave_midblock"), "austin_ave_and_wellington_ave")) %>% 
  mutate(station = str_replace_all(station, coll("ewing_ave_and_96th_st"), "ewing_ave_and_96th_st_n")) %>% 
  mutate(station = str_replace_all(station, coll("kedvale_ave_and_63rd_st"), "kedvale_ave_and_63rd_st_e")) %>% 
  mutate(station = str_replace_all(station, coll("kedzie_and_103rd_st_west"), "kedzie_and_103rd_st_w")) %>% 
  mutate(station = str_replace_all(station, coll("kedzie_ave_and_61st_pl"), "kedzie_ave_and_61st_pl_e")) %>% 
  mutate(station = str_replace_all(station, coll("kedzie_ave_andamp_62nd_pl"), "kedzie_ave_and_62nd_pl")) %>% 
  mutate(station = str_replace_all(station, coll("keeler_ave_and_madison_st"), "keeler_ave_and_madison_st_s")) %>% 
  mutate(station = str_replace_all(station, coll("kenneth_ave_and_63rd_st"), "kenneth_ave_and_63rd_st_e")) %>% 
  mutate(station = str_replace_all(station, coll("mt_greenwood_library_north"), "mt_greenwood_library_n")) %>% 
  mutate(station = str_replace_all(station, coll("n_shore_channel_trail_and_argyle_ave"), "n_shore_channel_trail_and_argyle_st")) %>% 
  mutate(station = str_replace_all(station, coll("prairie_ave_and_47th_st_midblock"), "prairie_ave_and_47th_st")) %>% 
  mutate(station = str_replace_all(station, coll("talman_ave_and_51st_st_midblock"), "talman_ave_and_51st_st")) %>% 
  mutate(station = str_replace_all(station, coll("whippie_st_and_26th_st"), "whipple_st_and_26th_st")) %>% 
  mutate(station = str_replace_all(station, coll("woodlawn_ave_and_63rd_st_ne"), "woodlawn_ave_and_63rd_st_n")) %>% 
  mutate(station = str_replace_all(station, coll("woodlawn_ave_and_63rd_st_se"), "woodlawn_ave_and_63rd_st_s")) %>% 
#   Stations that appear to be divvy service
  mutate(station = str_replace_all(station, coll("base_2132_w_hubbard"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("base_2132_w_hubbard_warehouse"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("divvy_cassette_repair_mobile_station"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("divvy_valet_oakwood_beach"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("hastings_wh_2"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("pawel_bialowas_test_pbsc_station"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("throop_hastings_mobile_station"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("west_chi_watson"), "cyclistic_service")) %>% 
  mutate(station = str_replace_all(station, coll("westchi"), "cyclistic_service")) %>% 
#   Stations that appear to be out of service
  mutate(station = str_replace_all(station, coll("dusable_lake_shore_dr_and_ohio_st"), "out_of_service")) %>% 
  mutate(station = str_replace_all(station, coll("lamon_ave_and_archer_ave"), "out_of_service")) %>% 
  mutate(station = str_replace_all(station, coll("morgan_st_and_lake_st"), "out_of_service")) %>% 
  mutate(station = str_replace_all(station, coll("newhastings"), "out_of_service")) %>% 
  mutate(station = str_replace_all(station, coll("whipple_st_and_irving_park_rd"), "out_of_service")) %>% 
  rename(end_station = station) 
```

**Missing values analysis** 

1. Are there missing values?

```{r, echo=FALSE}
any_na(last_12m_v03) 
```

2. How many?

```{r, echo=FALSE}
n_miss(last_12m_v03)
```

3. Percent of missing data? 

```{r, echo=FALSE}
prop_miss(last_12m_v03)
```

4. Where are the NAs concentrated?

```{r, echo=FALSE}
miss_var_summary(last_12m_v03)
```

5. Check distribution of missing data with an UpSet plot

```{r, echo=FALSE}
gg_miss_upset(last_12m_v03, 
              nsets = 6, 
              nintersects = 6,
              matrix.color = "#619CFF",
              main.bar.color = "#619CFF",
              sets.bar.color = "#F8766D")
```

6. Missing value cases:

    + Complete cases

```{r, echo=FALSE}
na_cases_v00 <- last_12m_v03 %>% select(everything()) %>% filter(!complete.cases(.))
```

    + Case 1: start_id, start_station, end_station, end_id

```{r, echo=FALSE}
na_case1_v00 <- na_cases_v00 %>% filter(is.na(start_id)) %>% filter(is.na(end_id))
```

    + Case 2: end_station, end_id
    
```{r, echo=FALSE}
na_case2_v00 <- na_cases_v00 %>% filter(!is.na(start_station)) %>% filter(!is.na(end_lng))
```

    + Case 3: start_id, start_station
    
```{r, echo=FALSE}
na_case3_v00 <- na_cases_v00 %>% filter(is.na(start_id)) %>% filter(!is.na(end_id))
```

    + Case 4: end_station, end_id, end_lng, end_lat
    
```{r, echo=FALSE}
na_case4_v00 <- na_cases_v00 %>% filter(is.na(end_lng))
```

    + Case 5: start_station

```{r, echo=FALSE}
na_case5_v00 <- na_cases_v00 %>% filter(is.na(start_station)) %>% filter(!is.na(start_id)) %>% 
  filter(!is.na(end_station))
```

    + Case 6: start_station, end_station, end_id

```{r, echo=FALSE}
na_case6_v00 <- na_cases_v00 %>% filter(is.na(start_station)) %>% filter(!is.na(start_id)) %>% 
  filter(is.na(end_station))
```

7. Could the missing values be identified using other variables, other observations? Missing At Random (MAR)

    + Case 1: Yes, from location data and valid station names
    
    + Case 2: Yes, from location data and valid station names
    
    + Case 3: Yes, from location data and valid station names
    
    + Case 4: No, because end_lng is missing
    
    + Case 5: Yes, from location data and valid station names
    
    + Case 6: Yes, from location data and valid station names  

8.  Filter out cyclistic service, out of service, and linder ave and archer ave

```{r, echo=FALSE}
last_12m_v04 <- last_12m_v03 %>% filter(!start_station == "cyclistic_service") %>% 
  filter(!end_station == "cyclistic_service") %>% filter(!start_station == "out_of_service") %>% 
  filter(!end_station == "out_of_service") %>% filter(!start_station == "linder_ave_and_archer_ave") %>% 
  filter(!end_station == "linder_ave_and_archer_ave")
```

last_12m_v04 is a 'partially clean' data set of complete cases

9.  Use complete cases to fill gaps

    + Filter complete cases

```{r, echo=FALSE}
complete_v00 <- last_12m_v03 %>% select(ride_id, start_station:end_lng) %>% filter(complete.cases(.))
```

    + Filter them by distinct location data and sort by start_lng

```{r, echo=FALSE}
complete_v01 <- complete_v00 %>% distinct(start_lat, start_lng, .keep_all = TRUE) %>% arrange(start_lng)
```

    + Select unique pairs of location data for start (s) and end(e) stations

```{r, echo=FALSE}
unq_sloc_v00 <- complete_v00 %>% select(ride_id, start_station, start_id, start_lat, start_lng) %>% 
  distinct(start_lat, start_lng, .keep_all = TRUE)

unq_eloc_v00 <- complete_v00 %>% select(ride_id, end_station, end_id, end_lat, end_lng) %>% 
  distinct(end_lat, end_lng, .keep_all = TRUE) %>% 
  rename(start_station = end_station,
         start_id = end_id,
         start_lng = end_lng,
         start_lat = end_lat)
```

    + Combine into one table

```{r, combine-v02, echo=FALSE}
unq_rbnd_v00 <- rbind(unq_sloc_v00, unq_eloc_v00) %>% 
  rename(station = start_station,
         id = start_id,
         lng = start_lng,
         lat = start_lat) %>% arrange(lat, lng)
```

    + Group Cases 1:3, 5:6 and distinct them by location data

```{r, NAcases-v00, echo=FALSE}
ca_12356_v00 <- bind_rows(na_case1_v00, na_case2_v00, na_case3_v00, na_case5_v00, na_case6_v00) %>% 
  select(ride_id:bike_type, start_lat:ended) %>% 
  rename(lat = start_lat, lng = start_lng) %>% distinct(lat, lng, .keep_all = TRUE)

ca_12356_v01 <- left_join(ca_12356_v00, unq_rbnd_v00, by = c("lat", "lng"))

ca_12356_v02 <- ca_12356_v01 %>% select(ride_id.x:ended, station:id) %>% 
  rename(ride_id = ride_id.x,
         start_lat = lat,
         start_lng = lng,
         start_station = station,
         start_id = id) %>% 
  distinct(ride_id, .keep_all = TRUE)

ca_12356_v03 <- ca_12356_v02 %>% rename(lat = end_lat, lng = end_lng)

ca_12356_v04 <- left_join(ca_12356_v03, unq_rbnd_v00, by = c("lat", "lng"))

ca_12356_v05 <- ca_12356_v04 %>% select(ride_id.x:start_id, station:id) %>% 
  rename(ride_id = ride_id.x,
         end_lng = lng,
         end_lat = lat,
         end_station = station,
         end_id = id) %>% distinct(ride_id, .keep_all = TRUE) %>% 
  relocate(start_station:end_id, .before = start_lat)
```

    + Continue analysis of missing data

```{r, NAcases-v01, echo=FALSE}
last_12m_v05 <- bind_rows(last_12m_v04, ca_12356_v05) 

unrpaird_v00 <- anti_join(last_12m_v03, last_12m_v05, by = "ride_id")

gg_miss_upset(unrpaird_v00, 
              nsets = 6, 
              nintersects = 6,
              matrix.color = "#619CFF",
              main.bar.color = "#619CFF",
              sets.bar.color = "#F8766D")
```

    + Cases without end_lng left out (these might be stolen/damaged units)

```{r, NAcases-v02, echo=FALSE}
unrpaird_v01 <- unrpaird_v00  %>% filter(!is.na(end_lng))

unrpaird_v02 <- unrpaird_v01 %>% select(ride_id:bike_type, start_lat:ended) %>% 
  rename(lat = start_lat, lng = start_lng)

stations_v06 <- stations_v05 %>% rename(lat = valid_latitude,
                                        lng = valid_longitude)

unrpaird_v03 <- left_join(unrpaird_v02, stations_v06, by = c("lat", "lng"))

unrpaird_v04 <- unrpaird_v03 %>% select(everything()) %>% rename(start_lat = lat,
                                                                 start_lng = lng,
                                                                 start_station = station,
                                                                 start_id = valid_id)

unrpaird_v05 <- unrpaird_v04 %>% rename(lat = end_lat, lng = end_lng)

unrpaird_v06 <- left_join(unrpaird_v05, stations_v06, by = c("lat", "lng"))

unrpaird_v07 <- unrpaird_v06 %>% select(everything()) %>% rename(end_lat = lat,
                                                                 end_lng = lng, 
                                                                 end_station = station,
                                                                 end_id = valid_id) %>% 
  relocate(start_station:end_id, .before = start_lat) %>% na.omit()

last_12m_v06 <- bind_rows(last_12m_v05, unrpaird_v07)

unrpaird_v08 <- anti_join(last_12m_v03, last_12m_v06, by="ride_id")

unrpaird_v09 <- unrpaird_v08 %>% filter(!is.na(end_lng))
```

    + Use the S2 package to identify a close match by location

```{r, NAcases-v03, echo=FALSE}
unrpaird_v10 <- unrpaird_v09 %>% select(ride_id:bike_type, start_lat:start_lng) %>% arrange(start_lat)

stations_v07 <- stations_v06 %>% arrange(lat)

stations_v07$closest <- 1:nrow(stations_v07)

set1_s2_v00 <- s2_lnglat(unrpaird_v10$start_lng, unrpaird_v10$start_lat)

set2_s2_v00 <- s2_lnglat(stations_v07$lng, stations_v07$lat)

unrpaird_v10$closest <- s2_closest_feature(set1_s2_v00, set2_s2_v00)

unrpaird_v11 <- left_join(unrpaird_v10, stations_v07, by = "closest")

unrpaird_v12 <- unrpaird_v11 %>% select(ride_id:bike_type, station:lng) %>% 
  rename(start_station = station,
         start_id = valid_id,
         start_lat = lat,
         start_lng = lng)

unrpaird_v13 <- unrpaird_v09 %>% select(ride_id, end_lat:ended) %>% arrange(end_lat)

set1_s2_v01 <- s2_lnglat(unrpaird_v13$end_lng, unrpaird_v13$end_lat)

unrpaird_v13$closest <- s2_closest_feature(set1_s2_v01, set2_s2_v00)

unrpaird_v14 <- left_join(unrpaird_v13, stations_v07, by = "closest")

unrpaird_v15 <- unrpaird_v14 %>% select(ride_id, started:ended, station:lng) %>% 
  rename(end_station = station,
         end_id = valid_id,
         end_lat = lat,
         end_lng = lng)

unrpaird_v16 <- left_join(unrpaird_v12, unrpaird_v15, by = "ride_id")

unrpaird_v17 <- unrpaird_v16 %>% filter(!start_station == "cyclistic_service") %>% 
  filter(!end_station == "cyclistic_service") %>% filter(!start_station == "out_of_service") %>% 
  filter(!end_station == "out_of_service") %>% filter(!start_station == "linder_ave_and_archer_ave") %>% 
  filter(!end_station == "linder_ave_and_archer_ave")

unrpaird_v18 <- unrpaird_v17 %>% relocate(end_station:end_lng, .before = start_lat) %>%  
  relocate(start_lat:start_lng, .before = end_lat)

last_12m_v07 <- bind_rows(last_12m_v06, unrpaird_v18)

```

**last_12m_v07 is clean data without missing values**

## Manipulation

1. Using the lubridate package, extract date, month, day
2. Group months by season
3. Label months
4. Identify days of the week
5. Calculate trip duration
6. Case trip duration

```{r, manipulation-v00, echo=FALSE}
last_12m_v08 <- last_12m_v07 %>% 
  mutate(start_date = date(last_12m_v07$started),
    start_month = month(last_12m_v07$started, label = FALSE),
    start_day = wday(last_12m_v07$started, label = FALSE),
    season = case_when(
      start_month %in% 1:2 ~ "Winter",
      start_month %in% 3:5 ~ "Spring",
      start_month %in% 6:8 ~ "Summer",
      start_month %in% 9:11 ~ "Fall",
      start_month %in% 12 ~ "Winter",
      ),
    month = case_when(
      start_month %in% 1 ~ "Jan",
      start_month %in% 2 ~ "Feb",
      start_month %in% 3 ~ "Mar",
      start_month %in% 4 ~ "Apr",
      start_month %in% 5 ~ "May",
      start_month %in% 6 ~ "Jun",
      start_month %in% 7 ~ "Jul",
      start_month %in% 8 ~ "Aug",
      start_month %in% 9 ~ "Sep",
      start_month %in% 10 ~ "Oct",
      start_month %in% 11 ~ "Nov",
      start_month %in% 12 ~ "Dec",
    ),
    weekday = case_when(
      start_day %in% 1 ~ "Sun",
      start_day %in% 2 ~ "Mon",
      start_day %in% 3 ~ "Tue",
      start_day %in% 4 ~ "Wed",
      start_day %in% 5 ~ "Thu",
      start_day %in% 6 ~ "Fri",
      start_day %in% 7 ~ "Sat"
      ),
    duration = difftime(last_12m_v07$ended, last_12m_v07$started, units = "mins"),
    usage = case_when(
      duration < 1 ~ "invalid",
      duration >= 1 &
      duration <= 1440 ~ "single_day",
      duration > 1440 ~ "multiday"
      )
  )
```

7. Check date-time manipulation

```{r, echo=FALSE}
table(str_count(last_12m_v08$usage))
```

    + 110,435 invalid records, 
    + 5,742,806 records as single_day
    + 445 multiday, 

8. Reshape the table

    + Group by user_type and bike_type
    + Select variables relevant to the analysis
    + Ignore station IDs and vars used for calculations
    + Filter by usage: single_day
    + Omit missing values
    + Sort by Season, Month, Day of the Week

```{r, echo=FALSE}
last_12m_v09 <- last_12m_v08 %>% 
  group_by(user_type, bike_type) %>% select(user_type:start_station, end_station, start_lat:end_lng, season:usage) %>% 
  filter(., grepl('single_day', usage)) %>% na.omit() %>% arrange(season, month, weekday)
```

    + Remove _bike
    + Unsnake_case strings

```{r, echo=FALSE}
last_12m_v10 <- last_12m_v09 %>% mutate(bike_type = str_remove_all(bike_type, coll("_bike"))) %>% 
  mutate(start_station = str_replace_all(start_station, coll("_"), " ")) %>% 
  mutate(end_station = str_replace_all(end_station, coll("_"), " ")) %>%            
  mutate(user_type = str_to_title(user_type)) %>% 
  mutate(bike_type = str_to_title(bike_type)) %>% 
  mutate(start_station = str_to_title(start_station)) %>% 
  mutate(end_station = str_to_title(end_station))
```

    + Check output for missing values
    
```{r, echo=FALSE}
any_na(last_12m_v10)
```

9. Split into members and casuals
    
```{r, echo=FALSE}
members_v00 <- last_12m_v10 %>% filter(user_type == "Member")
casuals_v00 <- last_12m_v10 %>% filter(user_type == "Casual")
```

# Visualizations and Key Findings {.tabset}

## Descriptive Analysis

1. Compare members and casual riders
    
```{r, echo=FALSE}
ggplot(data = last_12m_v10)+
  geom_bar(mapping = aes(x = user_type, fill = bike_type))+ 
  labs(x="",
       y="",
       title="Bike Preference",
       caption="")+ 
  scale_y_continuous(labels = label_number(suffix = "  K", scale = 1e-3))+ 
  scale_fill_manual(name = "",
                    labels = c("Classic", "Docked", "Electric"),
                    values = c("#619CFF", "61BEFF", "#F8766D"))
```

```{r, echo=FALSE}
table(last_12m_v10$user_type)
table(members_v00$bike_type)
table(casuals_v00$bike_type)
```

      Out of 5,598,305 valid trips in the last 12 months, 3,261,883 were by members, and 2,336,422 were by casual riders
      members used classic bikes for 1,833,041 trips, and electric bikes for 1,428,842 trips
      casual riders used classic bikes for 1,012,191 trips, docked bikes for 203,021 trips, and electric bikes for 1,121,210 trips
      the concept of docked bikes is yet to be clarified
      In percentages, members used 55% classic bikes, 45% electric bikes
      Casuals used 52% classic (includes docked) and 48% electric. 
      
    
```{r, echo=FALSE}
ggplot(data = last_12m_v10)+
  geom_bar(mapping = aes(x = as.numeric(duration), fill = user_type))+ 
  labs(x="Mins",
       y="",
       title="Trip Duration",
       caption="")+
  scale_x_continuous(limits = c(1, 45))+
  scale_y_continuous(labels = label_number(suffix = "  K", scale = 1e-3))+ 
  scale_fill_manual(name = "",
                    labels = c("Casual", "Member"),
                    values = c("#619CFF", "#F8766D"))
```

```{r, echo=FALSE}
mean(members_v00$duration)
mean(casuals_v00$duration)
```

      On average, members rode for shorter trips lasting 13 min while casuals average trip lasted 24 mins
      Most trips lasted 45 mins or less.

```{r, echo=FALSE}
last_12m_v10$season <- factor(last_12m_v10$season, levels = c("Winter", "Spring", "Summer", "Fall"))

ggplot(data = last_12m_v10)+
  geom_bar(mapping = aes(x = season, fill = user_type))+ 
  labs(x="",
       y="",
       title="Seasonal Ridership",
       caption="")+ 
  scale_y_continuous(labels = label_number(suffix = "  K", scale = 1e-3))+ 
  scale_fill_manual(name = "",
                    labels = c("Casual", "Member"),
                    values = c("#619CFF", "#F8766D"))

last_12m_v10 %>% group_by(user_type, season) %>% summarise(n=n())
```

```{r, echo=FALSE}
aggregate(last_12m_v10$duration ~ last_12m_v10$user_type + last_12m_v10$season, FUN = mean)
```

      By season:
      Members rode between 11 mins in Winter and 14 mins in Summer
      Casual riders rode between 19 mins in Winter, and 25 mins in Spring
      Casual riders average trip duration nearly doubles members every season


```{r, echo=FALSE}
last_12m_v10$month <- factor(last_12m_v10$month, levels = c("Nov", "Dec", "Jan", "Feb", "Mar", "Apr", 
                                                              "May", "Jun", "Jul", "Aug", "Sep", "Oct"))

ggplot(data = last_12m_v10)+
  geom_bar(mapping = aes(x = month, fill = user_type))+ 
  labs(x="",
       y="",
       title="Monthly Ridership",
       caption="")+ 
  scale_y_continuous(labels = label_number(suffix = "  K", scale = 1e-3))+ 
  scale_fill_manual(name = "",
                    labels = c("Casual", "Member"),
                    values = c("#619CFF", "#F8766D"))

last_12m_v10 %>% group_by(user_type, month) %>% summarise(n=n())
```

```{r, echo=FALSE}
aggregate(last_12m_v10$duration ~ last_12m_v10$user_type + last_12m_v10$month, FUN = mean)
```

      By month:
      May to Oct represent the highest concentration of users (peak months). These are warmer months in Chicago
      Max usage in July
      Nov to Mar represent the lowest with Jan being the Min.
      Trip durations appears to be consistent throughout, except for colder months 

```{r, echo=FALSE}
last_12m_v10$weekday <- factor(last_12m_v10$weekday, levels = c("Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"))

ggplot(data = last_12m_v10)+
  geom_bar(mapping = aes(x = weekday, fill = user_type))+ 
  labs(x="",
       y="",
       title="Weekly Ridership",
       caption="")+ 
  scale_y_continuous(labels = label_number(suffix = "  K", scale = 1e-3))+ 
  scale_fill_manual(name = "",
                    labels = c("Casual", "Member"),
                    values = c("#619CFF", "#F8766D"))

last_12m_v10 %>% group_by(user_type, weekday) %>% summarise(n=n())
```

    By day of the week:
    Members use the service more during the week (Mon to Fri)
    Casuals use the service more during weekends, peak use on Saturdays

    Cyclistic Stations

```{r, echo=FALSE}
b <- cbind(stations_v07$lng, stations_v07$lat)

Chicago_map1 <- leaflet(data = b) %>% setView(lng = -87.62791, lat = 41.88250, zoom = 12) %>% 
  addTiles() %>% 
  addMarkers(clusterOptions = markerClusterOptions())

Chicago_map1
```

    Popular stations among casual users during Fall weekends

```{r, echo=FALSE}
#      Start stations - Fall weekends
pop_stns_v00 <- last_12m_v10 %>% 
  group_by(user_type, season, weekday, start_station) %>% 
  summarise(n = n()) %>% arrange(desc(n)) %>% 
  filter(., grepl('Casual', user_type)) %>% 
  filter(., grepl('Fall', season)) %>% 
  filter(., weekday == 'Sat' | weekday == 'Sun') %>% 
  head(n = 25L)

#      End stations - Fall weekends
pop_stne_v00 <- last_12m_v10 %>% 
  group_by(user_type, season, weekday, end_station) %>% 
  summarise(n = n()) %>% arrange(desc(n)) %>% 
  filter(., grepl('Casual', user_type)) %>% 
  filter(., grepl('Fall', season)) %>% 
  filter(., weekday == 'Sat' | weekday == 'Sun') %>% 
  head(n = 25L)

pop_stns_v01 <- pop_stns_v00 %>% mutate(station = start_station)
pop_stne_v01 <- pop_stne_v00 %>% mutate(station = end_station)
pop_stnf_v00 <- rbind(pop_stns_v01, pop_stne_v01)
pop_stnf_v01 <- pop_stnf_v00 %>% select(n, station)

stations_v08 <- stations_v07 %>% 
  mutate(station = str_replace_all(station, coll("_"), " ")) %>% 
  mutate(station = str_to_title(station))
stations_v08 <- stations_v08 %>% select(station, lat, lng)

pop_stnf_v02 <- left_join(pop_stnf_v01, stations_v08) %>% arrange(desc(n)) %>% 
  distinct(station, .keep_all = TRUE) %>% 
  arrange(station)

pop_stnf_v03 <- pop_stnf_v02 %>% ungroup() %>% select(n:lng) %>% distinct(station, .keep_all = TRUE) %>% 
  arrange(desc(n)) %>% head(n=10L)

fall <- cbind(pop_stnf_v03$lng, pop_stnf_v03$lat)

Chicago_map2 <- leaflet(data = fall) %>% setView(lng = -87.62791, lat = 41.88250, zoom = 12) %>% 
  addTiles() %>% addMarkers()
Chicago_map2
```

```{r, table-v05, echo=FALSE, results = 'asis'}
table_v05 <- pop_stnf_v03 %>% rename(Rides = n, `Station Name` = station)
knitr::kable(table_v05, caption = "Table 5. Top 10 Popular stations for casuals during Fall weekends") 
```

    Popular stations among casual users during Summer weekends



```{r, echo=FALSE}
#       Start stations - Summer weekends
pop_stns_v02 <- last_12m_v10 %>% 
  group_by(user_type, season, weekday, start_station) %>% 
  summarise(n = n()) %>% arrange(desc(n)) %>% 
  filter(., grepl('Casual', user_type)) %>%
  filter(., grepl('Summer', season)) %>% 
  filter(., weekday == 'Sat' | weekday == 'Sun') %>% 
  head(., n=25L)

#       End stations in Summer weeekends
pop_stne_v02 <- last_12m_v10 %>% 
  group_by(user_type, season, weekday, end_station) %>% 
  summarise(n = n()) %>% arrange(desc(n)) %>% 
  filter(., grepl('Casual', user_type)) %>% 
  filter(., grepl('Summer', season)) %>% 
  filter(., weekday == 'Sat' | weekday == 'Sun') %>% 
  head(., n=25L)

pop_stns_v03 <- pop_stns_v02 %>% mutate(station = start_station)
pop_stne_v03 <- pop_stne_v02 %>% mutate(station = end_station)
pop_stnf_v04 <- rbind(pop_stns_v03, pop_stne_v03)
pop_stnf_v05 <- pop_stnf_v04 %>% select(n, station)

pop_stnf_v06 <- left_join(pop_stnf_v05, stations_v08) %>% arrange(desc(n)) %>% distinct(station, .keep_all = TRUE)

pop_stnf_v07 <- pop_stnf_v06 %>% ungroup() %>% select(n:lng) %>% distinct(station, .keep_all = TRUE) %>% 
  arrange(desc(n)) %>% head(n=10L)

summer <- cbind(pop_stnf_v07$lng, pop_stnf_v07$lat)

Chicago_map3 <- leaflet(data = summer) %>% setView(lng = -87.62791, lat = 41.88250, zoom = 12) %>% 
  addTiles() %>% addMarkers()
Chicago_map3
```

```{r, table-v06, echo=FALSE, results = 'asis'}
table_v06 <- pop_stnf_v07 %>% rename(Rides = n, `Station Name` = station)
knitr::kable(table_v06, caption = "Table 6. Top 10 Popular stations for casuals during Summer Weekends") 
```



```{r, echo=FALSE}
#      Start stations - Winter weeks
pop_stns_v04 <- last_12m_v10 %>% 
  group_by(user_type, season, weekday, start_station) %>% 
  summarise(n = n()) %>% arrange(desc(n)) %>% 
  filter(., grepl('Casual', user_type)) %>%
  filter(., grepl('Winter', season)) %>% 
  filter(., weekday %in% c("Mon","Tue","Wed","Thu","Fri")) %>% 
  head(., n=25L)

#      End stations in Winter weeks
pop_stne_v04 <- last_12m_v10 %>% 
  group_by(user_type, season, weekday, end_station) %>% 
  summarise(n = n()) %>% arrange(desc(n)) %>% 
  filter(., grepl('Casual', user_type)) %>% 
  filter(., grepl('Winter', season)) %>% 
  filter(., weekday %in% c("Mon","Tue","Wed","Thu","Fri")) %>%
  head(., n=25L)

pop_stns_v05 <- pop_stns_v04 %>% mutate(station = start_station)
pop_stne_v05 <- pop_stne_v04 %>% mutate(station = end_station)
pop_stnf_v06 <- rbind(pop_stns_v05, pop_stne_v05)
pop_stnf_v07 <- pop_stnf_v06 %>% select(n, station)

pop_stnf_v08 <- left_join(pop_stnf_v07, stations_v08) %>% arrange(desc(n)) %>% distinct(station, .keep_all = TRUE)

pop_stnf_v09 <- pop_stnf_v08 %>% ungroup() %>% select(n:lng) %>% distinct(station, .keep_all = TRUE) %>% 
  arrange(desc(n)) %>% head(n=10L)

winter <- cbind(pop_stnf_v09$lng, pop_stnf_v09$lat)

Chicago_map4 <- leaflet(data = winter) %>% setView(lng = -87.62791, lat = 41.88250, zoom = 12) %>% 
  addTiles() %>% addMarkers()
Chicago_map4
```

```{r, table-v07, echo=FALSE, results = 'asis'}
table_v07 <- pop_stnf_v09 %>% rename(Rides = n, `Station Name` = station)
knitr::kable(table_v07, caption = "Table 7. Top 10 Popular stations for casuals during Winter weeks") 
```



```{r, echo=FALSE}
#      Start stations - Spring weeks
pop_stns_v06 <- last_12m_v10 %>% 
  group_by(user_type, season, weekday, start_station) %>% 
  summarise(n = n()) %>% arrange(desc(n)) %>% 
  filter(., grepl('Casual', user_type)) %>%
  filter(., grepl('Spring', season)) %>% 
  filter(., weekday %in% c("Mon","Tue","Wed","Thu","Fri")) %>% 
  head(., n=25L)
#      End stations in Spring weeks
pop_stne_v06 <- last_12m_v10 %>% 
  group_by(user_type, season, weekday, end_station) %>% 
  summarise(n = n()) %>% arrange(desc(n)) %>% 
  filter(., grepl('Casual', user_type)) %>% 
  filter(., grepl('Spring', season)) %>% 
  filter(., weekday %in% c("Mon","Tue","Wed","Thu","Fri")) %>%
  head(., n=25L)

pop_stns_v07 <- pop_stns_v06 %>% mutate(station = start_station)
pop_stne_v07 <- pop_stne_v06 %>% mutate(station = end_station)
pop_stnf_v10 <- rbind(pop_stns_v07, pop_stne_v07)
pop_stnf_v11 <- pop_stnf_v10 %>% select(n, station)

pop_stnf_v12 <- left_join(pop_stnf_v11, stations_v08) %>% arrange(desc(n)) %>% distinct(station, .keep_all = TRUE)

pop_stnf_v13 <- pop_stnf_v12 %>% ungroup() %>% select(n:lng) %>% distinct(station, .keep_all = TRUE) %>% 
  arrange(desc(n)) %>% head(n=10L)

spring <- cbind(pop_stnf_v13$lng, pop_stnf_v13$lat)

Chicago_map5 <- leaflet(data = spring) %>% setView(lng = -87.62791, lat = 41.88250, zoom = 12) %>% 
  addTiles() %>% addMarkers()
Chicago_map5
```

```{r, table-v08, echo=FALSE, results = 'asis'}
table_v08 <- pop_stnf_v13 %>% rename(Rides = n, `Station Name` = station)
knitr::kable(table_v07, caption = "Table 8. Top 10 Popular stations for casuals during Spring weeks") 
```



# Recommendations {.tabset}

## 1

Due to the fact that members used Cyclistic bikes more during the week and for shorter time than casuals, it is fair to conclude that members who are likely Chicago residents used our bikes for commuting. Therefore, casual riders who too live in Chicago and have not used cyclistic for commuting are more likely to sign up for an annual membership to do so. My first recommendation is to communicate the additional perk of commuting to casual riders at all stations. How? by placing posters with the message "Commute (Shorten) your Commute, become a Cyclistic member" or similar. Add a QR code for them to sign up for an annual membership. 

## 2

Conduct a peak season 7-day trial campaign. Locate Cyclistic consultants at popular stations over peak-season weekends. The consultants will hand out flyers with the "Try now" call-out. During the trial week, request riders to post their best "bike pick-up" photo to social media with the hashtag #ICommute2 to participate in a draw for 10 Free Annual Memberships. Announce winners in Cyclistic's SSMM. Locate consultants at stations listed in tables 5 and 6.

## 3 

Colder seasons will require a greater incentive for casuals to ride and become members. I recommend that we partner with indoor event organizers around Chicago and offer discounted tickets to casual riders upon signing up for a membership. Start with events at museums, the aquarium, art galleries, and music venues. Promote this at popular locations for casual riders in Winter-Spring as listed in tables 7 and 8.

# Resources {.tabset}

+ Data Wrangling with dplyr and tidyr: https://www.rstudio.com/wp-content/uploads/2015/02/data-wrangling-cheatsheet.pdf  
+ Lubridate package: https://evoldyn.gitlab.io/evomics-2018/ref-sheets/R_lubridate.pdf  

